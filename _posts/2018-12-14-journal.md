---
layout: post
date: 2018-12-14
title: Journal - RC5, illegal access, docs, clojure.test
---

Trying something new here ... writing down some visible things I worked on this week (not everything is visible of course :) and some conversations I was in around the Clojure sphere. This will be pretty rambly without much editing. Maybe I'll do this more, maybe not, let me know if it's useful.

=== IllegalAccessException

I spent some time earlier this week digging into an [IllegalAccessException](https://github.com/cognitect-labs/REBL-distro/issues/10) that was reported in REBL from people trying to use Java 11 + latest JavaFX + REBL. While I have spent some time working on illegal access warnings due to reflective accesses across modules with Java 9+, this one was a little different as it involved an actual exception. It also seemed like this particular error should have been caught by my changes in [CLJ-2066](https://dev.clojure.org/jira/browse/CLJ-2066).

Anyhow that involved trying to make something reproducible and examining the stack trace in more detail, which really told the story. There are two different paths in the Clojure reflector and CLJ-2066 addressed one of those, but this was in the second code path, trying to invoke a field or method reflectively.

The general problem the reflector faces is having a target object, a method name, and some parameters and the goal of either finding or invoking the most appropriate method. The reflector starts from the type of the target object to look for a matching method (same name, same arity, and compatible parameter types taking into account boxing, widening, etc). 

In the new Java module system, code inside a module is, by default, inaccessible by code outside the module. Modules declare which parts are visible by "exporting" packages. Reflection has full rein to examine everything, but invocations are gated by accessibility according to the module definition.

It's relatively common for a module to export a public interface, and a factory to create instances of the interface. Usually, the implementations are private and not exported. In this case, Clojure will have a target object of the private implementation class, but the methods on that private class are inaccessible. Invoking them will yield an illegal access warning or exception. Instead, the Clojure reflector needs to look up the class hierarchy and find a public, accessible variant of the method (usually the public interface). The reflector had some of that logic already, but the additionally accessibility check needed to be added, and this is all captured in [CLJ-2454](https://dev.clojure.org/jira/browse/CLJ-2454).

We are in the final burn down at this point to Clojure 1.10, having released RC4 last week. This access problem is squarely in the middle of compatibility with the latest Java releases, which is one of the key targets for 1.10, so we decided this was important enough to include before we release. That resulted in the release of 1.10.0-RC5.

=== Docs

I've also spent a lot of time in the last week updating docs on the web site. There are new bits and pieces of docs for 1.10 in several places and some migrations and updates from other places:

* [Protocol metadata extension](https://clojure.org/reference/protocols#_extend_via_metadata)
* [Error printing](https://clojure.org/reference/repl_and_main#_error_printing)
* [FAQ on illegal access warning](https://clojure.org/guides/faq#illegal_access)
* [tap](https://clojure.org/reference/repl_and_main#_tap)
* [Updated spec guide](https://clojure.org/guides/spec) for 1.10 error printing
* Updated a bunch of exception messages across many pages to match 1.10
* [FAQ on how to skip checking macro specs](https://clojure.org/guides/faq#skip_macros) - missed in 1.9 updates

Also, I migrated [Contrib workflow](https://clojure.org/community/workflow), [Creating Tickets](https://clojure.org/community/creating_tickets), and [Developing Patches](https://clojure.org/community/developing_patches) from the old community wiki. We plan to do a bit more clarifying some of the stuff in this area, so this is just a start. Sean Corfield requested some clarification around some of the contrib library stuff and I agree it's probably a good time to do so as I see a lot of confusion and false assumptions about that.

I also burned through a bunch of site PRs - thanks to everyone on those. I won't list them all but you can look at the [recently closed PRs](https://github.com/clojure/clojure-site/pulls?q=is%3Apr+is%3Aclosed+sort%3Aupdated-desc) for more detail. I will highlight the addition of a new [equality guide](https://clojure.org/guides/equality) from Andy Fingerhut that is a newly updated version from the guide he has maintained for many years. Glad to finally add it!

We have a private CI system that auto-builds the clojure.org and clojurescript.org web sites. That's been chugging along pretty much unattended for 3 years, but unfortunately the product where we have it hosted is shutting down tomorrow. So this week I've spent a bunch of time doing research to decide the best replacement option. Still working on that, but it will be a bit more manual till that's up and running.

=== clojure.test

I had a long and interesting conversation on Slack this week about clojure.test, originally triggered by a tweet from 

=== Other tidbits

* Uploaded the [Day of Datomic Cloud videos](https://www.youtube.com/playlist?list=PLZdCLR02grLoMy4TXE4DZYIuxs3Q9uc4i) from Strange Loop
* Doing prep for clj and the Clojure api docs in relation to 1.10 release
* Starting to look at some tools.deps stuff again

=== Non Clojure stuff I enjoyed this week...

New Vulfpeck album, [Hill Climber](https://vulfpeck.bandcamp.com/album/hill-climber)! I'm moderately obsessed with Vulfpeck and their [unrelenting funkiness](https://www.youtube.com/watch?v=Nq5LMGtBmis). Everyone should have more Vulf in their life. Sleeper track: Disco Ulysses.

Really good [podcast](https://art19.com/shows/the-ezra-klein-show/episodes/2e0501fe-9cdd-4cdb-9155-6b5393ff0384) with Ezra Klein interviewing Hasan Minhaj. Although actually, I think Hasan had some of the best questions for Ezra. Hasan's new show is really good, also check that out.
